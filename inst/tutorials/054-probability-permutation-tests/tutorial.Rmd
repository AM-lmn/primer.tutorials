---
title: 'Probability: Permutation Tests'
author: Yuhan Wu
tutorial:
  id: probability-permutation-tests
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: Explain what a permutation test is and give examples of its use.
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(gt)
library(primer.data)
knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 

# DK: add comments

set.seed(100)
all_assignments <- expand_grid(
            Yao = c(TRUE,FALSE),
            Emma = c(TRUE,FALSE),
            Cassidy = c(TRUE,FALSE),
            Tahmid = c(TRUE,FALSE),
            Diego = c(TRUE,FALSE)) %>%
pivot_longer(cols = everything(),
             values_to = "treatment") %>%
  mutate(control = ! treatment) %>%
  mutate(assignment = rep(1:32, each = 5)) %>%
  relocate(assignment, .before = name)
```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

<!-- Reread Chapter 4. Create a nice plot which shows the result of a permutation test, and then guide the student to doing it. Use this for background: 

https://www.youtube.com/watch?v=GmvpsJHGCxQ 
https://www.youtube.com/watch?v=rJ3AZCQuiLw
-->


## Introduction
###

Recall from Chapter 4 the stylized example of a Preceptor Table from the experiment which measured the causal effect of exposure to Spanish-speakers on attitudes toward immigration.

```{r, echo = FALSE}
# First, we create a tibble with the values we want for the table

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("13", "14", "?", "?", "3"),
       ycontrol = c("?", "?", "6", "12", "?"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
    tab_header(title = "Preceptor Table") %>% 
    cols_label(subject = md("ID"),
                  ytreat = md("$$Y_t(u)$$"),
                  ycontrol = md("$$Y_c(u)$$"),
                  ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
    cols_move(columns = c(ytreat, ycontrol), after = c(subject)) %>%
    tab_style(cell_borders(sides = "right"),
              location = cells_body(columns = c(subject))) %>%
    tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
              locations = cells_column_labels(columns = c(subject))) %>%
    cols_align(align = "center", columns = everything()) %>%
    cols_align(align = "left", columns = c(subject)) %>%
    tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol)) %>%
    tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff)) %>%
    fmt_markdown(columns = everything())
```

Recall that the question marks indicate data we would like to have but which is missing. For example, we would like to know what Yao's attitude *would have been* if he had been given the control but we don't know that, since he was given the treatment. Similarly, we would like to know what the causal effect of the treatment is on Emma, but we don't know that because of the Fundamental Problem of Causal Inference: we can only observe one of two potential outcomes for Emma.

###

A *permutation test* starts with the assumption that the true average treatment effect is zero, and then calculates how "surprising" our estimated average treatment effect is, given that assumption. If the surprise is big enough, we conclude that the average treatment effect is not zero.


## Experiment assignments
###

<!-- DK: Build a three column tibble (with no "assignment column") which represents the assignments in the experiment. Use that tibble (and the experiment results) to calculate an estimated treatment effect. Highlight the assignments could have been different. Explain that, if they were, you can not calculate the estimated treatment effect which would have resulted in that case. Also teach them about expand grid, even if you don't use it here. (Best if you do. Or not! Your call!) -->



## All assignments
###

Although we assigned the treatment to Yao, Emma and Diego when we ran the experiment, this was not pre-ordained. Assignment was random. So, it might have been the case that we assigned the treatment to Emma and Cassidy.

<!-- Create a tibble which shows the 32 possible assignments of treatment and control. Need to ensure that each person has the treatment and control the same number of times.  x %>% filter(name == "Yao") %>% count(treatment, control) -->

<!-- Show how to use a single assigment to, by hand, calculate the estimate causal effect. But use the assignment which actually happened in reality! -->

```{r}
all_assignments
  
```

### Exercise 1

Before we creates the tibble which shows all possible combinations treatments and controls, we first need to understand the special properties of `expand_grid()`, and how it differentiate for `tibble()`. Use `tibble()` which includes three arguments, `a = 0:1`,`b = 0:1` and ` c = 0:1`.This should creates a tibble with 2 rows

```{r assignments-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-1-hint, eval = FALSE}
tibble(a = 0:1, b = 0:1, c = 0:1)
```

###
`tibble()` returns 2 rows with each one of the variable returns `0` for the first row, and `1` for the second row. `tibble()` strictly follows where only creates two values for each variable *independently*.

### Exercise 2

Now use `expand_grid()` which includes three arguments, `a = 0:1`,`b = 0:1` and ` c = 0:1`.This should creates a tibble with 2 rows
```{r assignments-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-2-hint, eval = FALSE}
expand_grid(a = 0:1, b = 0:1, c = 0:1)
```

###
Note the difference between `tibble()` and `expand_grid()`, where `tibble()` creates two rows, and `expand_grid()` creates 8 rows. `expand_grid()` is looking at the three arguments *continuously*, where it first look at variable `a` and generate 2 rows, then it match the 2 values of `b` for *each* value of `a` generate 4 rows, then it match the 2 values of `c` to the 4 rows of `a` and b` generate total of 8 rows. We use `expand_grid()` for the probability problem which we need to consider all the possible combinations of outcomes.

### Exercise 3

Use `expand_grid()` replace the variable `a`,`b` and `c` with `Yao`, `Emma` and `Cassidy`, replace `0:1` with `c(TRUE,FALSE)`. Your result should also have 8 rows.
```{r assignments-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-3-hint, eval = FALSE}
 expand_grid(Yao = c(TRUE,FALSE),
             Emma = c(TRUE,FALSE),
             Cassidy = c(TRUE,FALSE))
```

###
This time instead of integers like 0 and 1, we use logical vector like `TRUE` and `FALSE`.

### Exercise 4

Now adds another two argumenst `Tahmid` and `Diego`, and set both of them to `c(TRUE,FALSE)` as well.
```{r assignments-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-4-hint, eval = FALSE}
expand.grid(
            Yao = c(TRUE,FALSE),
            Emma = c(TRUE,FALSE),
            Cassidy = c(TRUE,FALSE),
            Tahmid = c(TRUE,FALSE),
            Diego = c(TRUE,FALSE))
```

###
Now we have an complete 32*5 tibble, which each 32 rwos representing an different possible outcomes. 

### Exercise 5

Use `pivot_longer()` which include two arguments, first set `cols` equal to `everything()`, then set `values_to` equal to `"treatment"`
```{r assignments-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-5-hint, eval = FALSE}
pivot_longer(cols = everything(),
             values_to = "treatment")
```

###
This step allow us to combine the 5 columns in to one, `cols` means combine how many colums, `everything()` means select every columns in the tibble, but if we have 6 columns while only wants to select 5 of them we can use `c(Yao,Emma,Cassidy,Tahmid,Diego)` where we manually select which columns using `c()`.

### Exercise 6

Use `mutate()` creates a new variable `control` which is equal to `! treatment `.
```{r assignments-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-6-hint, eval = FALSE}
mutate(control = ! treatment) 
```

###

`!` operator means "not", but since treatment is a logical vector not `TRUE` basically means `FALSE` and vice versa.

### Exercise 7

Use `mutate()` create a new variable `assignment` equal to `rep()` which has two arguments, with first being `1:32` and then set `each` to 5.
```{r assignments-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-7-hint, eval = FALSE}
mutate(assignment = rep(1:32, each = 5)) 
```

###
The `rep()` function here is alittle different than the `rep()` we use before where the two arguments is the value and it's repeat times, with `each` we generate each number in the value certain amount of time.


### Exercise 8

Use `relocate()` which has two arguments, the first being `assignment`, then set `.befire` equal to `name`.

```{r assignments-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-8-hint, eval = FALSE}
relocate(assignment, .before = name)
```

Now you have creates a tibble like this.
```{r}
all_assignments
```


### Exercise 9

Assign everything above in a variable `all_assignments`.
```{r assignments-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-9-hint, eval = FALSE}
all_assignments <-
  ...
```

###


### Exercise 10

Now let's pull up the the `real world` data or the preceptor table from the 32 possible combinations. 

```{r, echo = FALSE}
# First, we create a tibble with the values we want for the table

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("13", "14", "?", "?", "3"),
       ycontrol = c("?", "?", "6", "12", "?"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
    tab_header(title = "Preceptor Table") %>% 
    cols_label(subject = md("ID"),
                  ytreat = md("$$Y_t(u)$$"),
                  ycontrol = md("$$Y_c(u)$$"),
                  ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
    cols_move(columns = c(ytreat, ycontrol), after = c(subject)) %>%
    tab_style(cell_borders(sides = "right"),
              location = cells_body(columns = c(subject))) %>%
    tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
              locations = cells_column_labels(columns = c(subject))) %>%
    cols_align(align = "center", columns = everything()) %>%
    cols_align(align = "left", columns = c(subject)) %>%
    tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol)) %>%
    tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff)) %>%
    fmt_markdown(columns = everything())
```

Start a pipe with `all_assignments`, use `filter()` to filter out `assignment` number 13, Which Yao, Emma, and Diego gets treatment (returns `TRUE` under `treatment` column), Cassidy and Tahmid gets control (returns `FALSE` under `treatment` column).

```{r assignments-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-10-hint, eval = FALSE}
all_assignments %>%
  filter(assignment == 13)
```

###

### Exercise 11

Now use `mutate()` create a new variable `outcomes` set it equal to `c(13, 14, 6, 12, 3)`.
```{r assignments-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-11-hint, eval = FALSE}
all_assignments %>%
  filter(assignment == 13) %>%
  mutate(outcomes = c(13, 14, 6, 12, 3))
```


### Exercise 12

Use `mutate()` create a variable `treatment_outcomes` and set it equal to `case_when()`, which hass two arguments, first when `treatment == TRUE` use `~` returns `outcomes`, then when `treatment == FALSE` use `~` returns `0`.
```{r assignments-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-12-hint, eval = FALSE}
all_assignments %>%
  filter(assignment == 13) %>%
  mutate(outcomes = c(13, 14, 6, 12, 3)) %>%
  mutate(treatment_outcomes = case_when(
   treatment == TRUE ~ outcomes,
   treatment == FALSE ~ 0)) 
```

###
This will generate a list only including values for Yao, Emma and Diego, we replace the question mark in the preceptor table with 0, as a person cannot have treatment or control the same time.

### Exercise 13

Use `mutate()` create a variable `control_outcomes` and set it equal to `case_when()`, which hass two arguments, first when `control == TRUE` use `~` returns `outcomes`, then when `control == FALSE` use `~` returns `0`.
```{r assignments-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-13-hint, eval = FALSE}
all_assignments %>%
  filter(assignment == 13) %>%
  mutate(outcomes = c(13, 14, 6, 12, 3)) %>%
  mutate(treatment_outcomes = case_when(
   treatment == TRUE ~ outcomes,
   treatment == FALSE ~ 0)) %>%
   mutate(control_outcomes = case_when(
   control == TRUE ~ outcomes,
   control == FALSE ~ 0
   ))
```

###
Same idea, if the column `control` returns `TRUE` then that person gets the control group, and if it returns `FALSE`, that person gets the treatment group.

### Exercise 14

Use `group_by()` to group `assignment`,
```{r assignments-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-14-hint, eval = FALSE}
... %>%
  group_by()
```

###

### Exercise 15

Use `summairse()` to creates variable `mean_difference` and set it equal to the the `mean()` of `treatment_outcomes` minus the `mean()` of `control_outcomes`.

```{r assignments-15, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r assignments-15-hint, eval = FALSE}
... %>%
  summarise(mean_difference = mean(treatment_outcomes)- mean(control_outcomes)) 
```

###
You should have something like this. With two columns one is `assignment` and one is `mean_difference`.

```{r}
all_assignments %>%
  filter(assignment == 13) %>%
  mutate(outcomes = c(13, 14, 6, 12, 3)) %>%
  mutate(treatment_outcomes = case_when(
   treatment == TRUE ~ outcomes,
   treatment == FALSE ~ 0)) %>%
   mutate(control_outcomes = case_when(
   control == TRUE ~ outcomes,
   control == FALSE ~ 0
   )) %>%
  mutate(treatment_outcomes = case_when(
    treatment == TRUE ~ outcomes,
    treatment == FALSE ~ 0)) %>%
  mutate(control_outcomes = case_when(
    control == TRUE ~ outcomes,
    control == FALSE ~ 0
  )) %>%
  group_by(assignment)%>%
  summarise(mean_difference = mean(treatment_outcomes)- mean(control_outcomes))
```

###
What does this means? Essentially we assume that the preceptor table is the real world data we get from some experiment, and then we calculate the *average treatment effect* which is +2.4. Now you might wonder, what we we do for the other 31 possibilities, in fact with only limited information we know, we cannot calculate the average treatment effect of other possible outcomes, because we don't know the values of the question marks in the preceptor table. So now we are stuck, what do we do? There is one ingenious method to get around with this, and that is *Null hypothesis*.

<!-- tibble(assignment number, name, treatment, control) with treatment and control being logical vectors. The tibble has 32 * 5 rows.  -->

## Null hypothesis
###

Let's assume that the causal effect for all units is equal to zero. 

```{r, echo = FALSE}
# First, we create a tibble with the values we want for the table

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("13", "14", "6", "12", "3"),
       ycontrol = c("13", "14", "6", "12", "3"),
       ydiff = c("0", "0", "0", "0", "0")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
    tab_header(title = "Preceptor Table",
    subtitle = "Data under the assumption that the causal effect is zero for all units") %>% 
    cols_label(subject = md("ID"),
                  ytreat = md("$$Y_t(u)$$"),
                  ycontrol = md("$$Y_c(u)$$"),
                  ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
    cols_move(columns = c(ytreat, ycontrol), after = c(subject)) %>%
    tab_style(cell_borders(sides = "right"),
              location = cells_body(columns = c(subject))) %>%
    tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
              locations = cells_column_labels(columns = c(subject))) %>%
    cols_align(align = "center", columns = everything()) %>%
    cols_align(align = "left", columns = c(subject)) %>%
    tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol)) %>%
    tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff)) %>%
    fmt_markdown(columns = everything())
```

This is our "null hypothesis."

We are assuming that the average treatment effect is 0 and that for example, the value 13 for Yao can be applied to both treatment and control. With this null hypothesis in place we eleminate all the question marks in the preceptor table, and be able to calculate all other 31 possible outcomes of the `assignment` tibble. Essentially, we are proposing an hypothesis, that there is no difference between the outcome with treatment and the outcome with control, we can explore this hypothesis by calculating all possible outcomes of the experiment, and if the average treatment effect of the "real" data appears frequently during all 32 outcomes, this means that our hypothesis is correct which also means that the treatment we give is ineffective.

Let's calculate the estimated treatment effect with Assignment Number 7 (or whatever) if the null hypothesis is correct. 

Need the assignment tibble, from which you are going to take just 5 rows. And you need a vector of 5 numbers which is the outcome. A vector is enough because the null hypothesis assumes that Yao's outcome is the same under treatment and control.

## All estimated treatment effects
###

<!-- Do the same thing as previous section, but for all 32 possible assigments. (Note that two of them will drop out because they are everyone gets treatment or everyone gets control.) Results in 30 numbers. Makes a bar chart of those 30 numbers. -->


```{r}
set.seed(100)
expand.grid(
            Yao = c(TRUE,FALSE),
            Emma = c(TRUE,FALSE),
            Cassidy = c(TRUE,FALSE),
            Tahmid = c(TRUE,FALSE),
            Diego = c(TRUE,FALSE)
            ) %>%
  pivot_longer(cols = everything(),
             values_to = "treatment") %>%
  mutate(control = ! treatment) %>%
  mutate(assignment = rep(1:32, each = 5)) %>%
  relocate(assignment, .before = name) %>%
  mutate(outcomes = rep(c(13, 14, 6, 12, 3), 32)) %>%
  unnest(outcomes)%>%
  mutate(treatment_outcomes = case_when(
    treatment == TRUE ~ outcomes,
    treatment == FALSE ~ 0)) %>%
  mutate(control_outcomes = case_when(
    control == TRUE ~ outcomes,
    control == FALSE ~ 0
  )) %>%
  group_by(assignment)%>%
  summarise(mean_difference = mean(treatment_outcomes)- mean(control_outcomes)) %>%
  ggplot(aes(x= mean_difference)) +
  geom_histogram(aes(y = after_stat(count/sum(count))), binwidth = 1,color = "white")+
  scale_x_continuous(breaks = seq(-7, 12, 1), labels = -7:12)+
  scale_y_continuous(labels= scales::percent_format(accuracy = 1))


  
  
```


### 

```{r}
A <- c(17,22,24,25,29)
B <- c(15,18,21) 
C <- c(15,16,18,20,25,14,19,23)
mn_d = mean(A) - mean(B)
A_2 <- sample(C, size = 5, replace = FALSE)
B_2 <- subset(C, ! C %in% A_2)
mn_d2 <- mean(A_2) - mean(B_2)
mn_d
mn_d2

# expand_grid(a = A, b = B, c = C) %>%
#   mutate(mean_d = mean(a) - mean(c)) %>%
#   mutate(a_2 = map_dbl(a, ~list(sample(.,size = 5, replace = FALSE)))) %>%
#   mutate(b_2 = map_dblt(a_2, ~list(subset(C, ! C %in% A_2))))
```


### Exercise 1

Suppose we design to verify that the height of Bamboo will increase significantly after adding certain auxin. Group A is the height of bamboos after adding a certain auxin; B is the the height of bamboos without adding auxin (all assumed values).

Group A (12 data in meters): 6, 6, 8, 9, 9, 10, 11, 14, 17, 20, 21, 23  
Group B (9 data in meters):  6, 8, 10, 11, 13, 15, 16, 17, 19

Use `tibble()` create two variables,the first variable `A` and set it equal to `list()` which include the 12 values above wrap around by `c()`. She second variable B and set it equal to `list()` which include the 9 values above wrap around by `c()`. Your result should only have 1 row.
```{r permutation-tests-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r permutation-tests-1-hint, eval = FALSE}
tibble(A = list(c(6, 6, 8, 9, 9, 10, 11, 14, 17, 20, 21, 23)),
       B = list(c(6, 8, 10, 11, 13, 15, 16, 17, 19)))
```

###
Our null hypothesis is: the added auxin will not promote the height growth of bamboo. In this test, if the null hypothesis is true, then the distribution of the data in group A and the distribution of data in group B are the same, that is, subject to the same distribution.

### Exercise 2

Next, construct the test statistic - the difference between the mean value of the height of bamboos in group A and the mean value of the height of bamboos in group B. 

Use `summarise()`
```{r permutation-tests-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r permutation-tests-2-hint, eval = FALSE}

```

###

### Exercise 3


```{r permutation-tests-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r permutation-tests-3-hint, eval = FALSE}

```

###

### Exercise 4


```{r permutation-tests-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r permutation-tests-4-hint, eval = FALSE}

```

###

### Exercise 5


```{r permutation-tests-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r permutation-tests-5-hint, eval = FALSE}

```

###

### Exercise 6


```{r permutation-tests-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r permutation-tests-6-hint, eval = FALSE}

```

###


## Summary
###

```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
