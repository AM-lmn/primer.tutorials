---
title: 'Probability: Permutation Tests'
author: Yuhan Wu
tutorial:
  id: probability-permutation-tests
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: Explain what a permutation test is and give examples of its use.
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(gt)
library(primer.data)
knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 

# DK: add comments

set.seed(100)
all_assignments <- expand_grid(
            Yao     = c(TRUE, FALSE),
            Emma    = c(TRUE, FALSE),
            Cassidy = c(TRUE, FALSE),
            Tahmid  = c(TRUE, FALSE),
            Diego   = c(TRUE, FALSE)) %>%
pivot_longer(cols = everything(),
             values_to = "treatment") %>%
  mutate(control = ! treatment) %>%
  mutate(assignment = rep(1:32, each = 5)) %>%
  relocate(assignment, .before = name)
```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

<!-- Create a nice plot which shows the result of a permutation test, and then guide the student to doing it. Use this for background: 

https://www.youtube.com/watch?v=GmvpsJHGCxQ 
https://www.youtube.com/watch?v=rJ3AZCQuiLw
-->


<!-- Use $Y_t$ and so on throughout. -->

<!-- Include a video that you like in your knowledge drops. -->

<!-- Add some knowledge drops. Think of all that they learned in Chapter 4! -->

<!-- Change construction of the tibble to add, via mutate(), all columns except for the first one. -->

## Introduction
### 

Recall from Chapter 4 the stylized example of a Preceptor Table from the experiment which measured the causal effect of exposure to Spanish-speakers on attitudes toward immigration. 

```{r echo = FALSE}
# First, we create a tibble with the values we want for the table

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("13", "14", "?", "?", "3"),
       ycontrol = c("?", "?", "6", "12", "?"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
    tab_header(title = "Preceptor Table") %>% 
    cols_label(subject = md("ID"),
                  ytreat = md("$$Y_t(u)$$"),
                  ycontrol = md("$$Y_c(u)$$"),
                  ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
    cols_move(columns = c(ytreat, ycontrol), after = c(subject)) %>%
    tab_style(cell_borders(sides = "right"),
              location = cells_body(columns = c(subject))) %>%
    tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
              locations = cells_column_labels(columns = c(subject))) %>%
    cols_align(align = "center", columns = everything()) %>%
    cols_align(align = "left", columns = c(subject)) %>%
    tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol)) %>%
    tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff)) %>%
    fmt_markdown(columns = everything())
```

Recall that the question marks indicate data we would like to have but which is missing. For example, we would like to know what Yao's attitude *would have been* if he had been given the control but we don't know that, since he was given the treatment. Similarly, we would like to know what the causal effect of the treatment is on Emma, but we don't know that because of the Fundamental Problem of Causal Inference: we can only observe one of two potential outcomes for Emma.

### 

A *permutation test* starts with the assumption that the true average treatment effect is zero, and then calculates how "surprising" our estimated average treatment effect is, given that assumption. If the surprise is big enough, we conclude that the average treatment effect is not zero.


## One assignment
### 

```{r echo = FALSE}
answer <-tibble(name = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego")) %>%
  mutate(treatment = c(TRUE, TRUE, FALSE, FALSE, TRUE)) %>%
  mutate(control = ! treatment) %>% 
  mutate(Y_t =  c(13, 14, NA ,NA ,3)) %>% 
  mutate(Y_c = c(NA, NA, 6, 12, NA)) %>%
  summarise(est_effect = mean(Y_t, na.rm = TRUE) - mean(Y_c, na.rm = TRUE))
```

<!-- Knowledge to drop in this section: First section builds the assignments tibble. (Should it be assignment or assignment*s*?) Discuss randomization and why it is important. Discuss why we might want "balance."  For example, it is obviously stupid to assign all five units to treatment and zero to control. But it is also suspect to do a 4 and 1 combination. We want to minimize the error in our estimates of both mean(Y_c) and mean(Y_t). To do that, we should seek balance since the marginal reduction in standard error is greater for whichever treatment has fewer observations. -->

In the experiment, Yao, Emma and Diego received the treatment while Cassidy and Tahmid did not. This "assignment" of treatments to units is only one of many possible assignments which could have, in theory, happened. The "assignment mechanism" is the process or procedure by which treatments are assigned to units. In this case, the assignment mechanism was random. Because of that, we can estimate the treatment effect by subtracting the average outcome for the controls from the average outcome of the treated. 



```{r echo = FALSE}
# First, we create a tibble with the values we want for the table

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("13", "14", "?", "?", "3"),
       ycontrol = c("?", "?", "6", "12", "?"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
    tab_header(title = "Preceptor Table") %>% 
    cols_label(subject = md("ID"),
                  ytreat = md("$$Y_t(u)$$"),
                  ycontrol = md("$$Y_c(u)$$"),
                  ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
    cols_move(columns = c(ytreat, ycontrol), after = c(subject)) %>%
    tab_style(cell_borders(sides = "right"),
              location = cells_body(columns = c(subject))) %>%
    tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
              locations = cells_column_labels(columns = c(subject))) %>%
    cols_align(align = "center", columns = everything()) %>%
    cols_align(align = "left", columns = c(subject)) %>%
    tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol)) %>%
    tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff)) %>%
    fmt_markdown(columns = everything())
```

### Exercise 1

Use `tibble()` create a new variable `name` and set it equal to "Yao", "Emma", "Cassidy", "Tahmid" and "Diego" combine using `c()`.

```{r one-assignment-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r one-assignment-1-hint-1, eval = FALSE}
tibble(name = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"))
```

### 

We generally only includes one variable made in `tibble()`, to make more column we can use `mutate()` to add the variable we desired.


### Exercise 2

Then, create a new variable `treatment` and set it equal to TRUE, TRUE, FALSE, FALSE, TRUE using `mutate()` and `c()`

```{r one-assignment-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r one-assignment-2-hint-1, eval = FALSE}
tibble(name = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego")) %>%
  mutate(treatment = c(TRUE, TRUE, FALSE, FALSE, TRUE))
```

### Exercise 3

Pipe down the result, then use `mutate()` create variable `control` and set it equal to `! treatment`.

```{r one-assignment-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r one-assignment-3-hint-1, eval = FALSE}
... %>%
  mutate(control = ! treatment)
```

### 

Now we have make our tibble which has only one combinations of treatments and controls, we calls this combinations "one assignment".

### Exercise 4

Use `mutate()` create a new variable `Y_t` and set it equal to `c(13, 14, NA, NA, 3)`.

```{r one-assignment-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r one-assignment-4-hint-1, eval = FALSE}
...%>%
  mutate(Y_t = c(13, 14, NA , NA , 3))
```

### 

We replace the question mark with NA because we do not know the outcome if Cassidy or Tahmid were to be given the treatment.

### Exercise 5

Similarily use `mutate()` create a new variable `Y_c` and set it equal to `c(NA, NA, 6, 12, NA)`.

```{r one-assignment-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r one-assignment-5-hint-1, eval = FALSE}
...%>%
  mutate(Y_c = c(NA, NA, 6, 12, NA))
```

### 

According to Fundamental Problem of Causal Inference we can only observe one of the possible outcomes for each individual. Therefore if we knows the value for $Y_t$ we don't know the value for $Y_c$ for the same person. And now observing the 4 columns we can see that the `TRUE` within the treatment column matches the value in column `Y_t` and the `FALSE` in treatment column match the `NA`, as well as the control columns vice verse.

### Exercise 6

Create a new variable, `t_outcome` which takes the value of `Y_t` if `treatment` equal TRUE and zero if it is not. Use `if_else()`. The three arguments for `if_else()` will be `treatment`, `Y_t` and `NA_real_`.



```{r one-assignment-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r one-assignment-6-hint-1, eval = FALSE}
tibble(name = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
  treatment = c(TRUE, TRUE, FALSE,FALSE,TRUE)) %>%
  mutate(control = ! treatment) %>% 
  mutate(Y_t =  c(13, 14, NA ,NA ,3)) %>% 
  mutate(Y_c = c(NA, NA, 6, 12, NA)) %>%
  mutate(t_outcome = if_else(treatment, Y_t, NA_real_))

```

### 

The `if_else()` statement has three arguments, the first is an condition statement which has to correspond to an logical vector like the treatment/control column, Then if the condition statement is `TRUE`, returns the second argument, if the condition statement is `FALSE` returns the third arguments. The fact that we are allow to replace NA with 0 is that we infer a person cannot get the treatment and effect the same time, so therefore it doesn't matter which value we give, as it will be taken into consider when we calculate the estimated causal effect.

### Exercise 7

Similarly, use `mutate()` create a variable `c_outcome` and set it equal to `if_else()` which has three arguments in order, `control`, then `Y_c` , then `NA_real_`. 

```{r one-assignment-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r one-assignment-7-hint-1, eval = FALSE}
tibble(name = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
  treatment = c(TRUE, TRUE, FALSE,FALSE,TRUE)) %>%
  mutate(control = ! treatment) %>% 
  mutate(Y_t =  c(13, 14, NA ,NA ,3)) %>% 
  mutate(Y_c = c(NA, NA, 6, 12, NA)) %>%
  mutate(t_outcome = if_else(treatment, Y_t, NA_real_)) %>%
  mutate(c_outcome = if_else(control, Y_c, NA_real_)) 
```

### 

We use `NA_real_` is to match the type of vectors of `Y_c` and `Y_T`, try replace `NA_real_` with `NA` and see what you get. Now you should have two columns that looks exactly like the previous two columns, this is because the TRUE / FALSE matches up with the values in `Y_t` and `Y_c`, in later tutorials you will be able to observe how this might change.

### Exercise 8

Use `summarise()` create an variable `est_effect`, and set it equal to the `mean()` of `t_outcome` minus the `mean()` of `c_outcome`.  Also within both `mean()` set `na.rm` equals `TRUE`. You should get an results of $+1$
```{r one-assignment-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r one-assignment-8-hint-1, eval = FALSE}
... %>%
  summarise(est_effect = mean(Y_t, na.rm = TRUE) - mean(Y_c, na.rm = TRUE))
```

### 

The fact that we use `na.rm` is to simply do not considered the `NAs` when calculating our estimated effect, so that the mean function only calculate the rows that have `actual` values.

### 

Now what does this means? Essentially we assume that the preceptor table is the real world data we get from some experiment, and then we calculate the *estimated treatment effect* which is $+1$. 

Now is this value (+1) sufficient to determine the effectiveness of the experiment, or in other word is this result `"surprise" enough to conclude that our treatment work. We don't know unless we tested for all other possible combinations of assignment, and compared all possible outcomes of estimated causal effect to the value +1. 



## All assignments
### 

Although we assigned the treatment to Yao, Emma and Diego when we ran the experiment, this was not pre-ordained. Assignment was random. So, it might have been the case that we assigned the treatment to Emma and Cassidy.


```{r}
all_assignments
  
```

### Exercise 1

Before we creates the tibble which shows all possible combinations treatments and controls, we first need to understand the special properties of `expand_grid()`, and how it differentiate for `tibble()`. Use `tibble()` which includes three arguments, `a = 0:1`,`b = 0:1` and ` c = 0:1`.This should creates a tibble with 2 rows

```{r all-assignments-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-1-hint-1, eval = FALSE}
tibble(a = 0:1, b = 0:1, c = 0:1)
```

### 

`tibble()` returns 2 rows with each one of the variable returns `0` for the first row, and `1` for the second row. `tibble()` strictly follows where only creates two values for each variable *independently*.

### Exercise 2

Now use `expand_grid()` which includes three arguments, `a = 0:1`,`b = 0:1` and ` c = 0:1`.This should creates a tibble with 2 rows
```{r all-assignments-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-2-hint-1, eval = FALSE}
expand_grid(a = 0:1, b = 0:1, c = 0:1)
```

### 

Note the difference between `tibble()` and `expand_grid()`, where `tibble()` creates two rows, and `expand_grid()` creates 8 rows. `expand_grid()` is looking at the three arguments *continuously*, where it first look at variable `a` and generate 2 rows, then it match the 2 values of `b` for *each* value of `a` generate 4 rows, then it match the 2 values of `c` to the 4 rows of `a` and b` generate total of 8 rows. We use `expand_grid()` for the probability problem which we need to consider all the possible combinations of outcomes.

### Exercise 3

Use `expand_grid()` replace the variable `a`,`b` and `c` with `Yao`, `Emma` and `Cassidy`, replace `0:1` with `c(TRUE,FALSE)`. Your result should also have 8 rows.
```{r all-assignments-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-3-hint-1, eval = FALSE}
 expand_grid(Yao = c(TRUE, FALSE),
             Emma = c(TRUE, FALSE),
             Cassidy = c(TRUE,FALSE))
```

### 

This time instead of integers like 0 and 1, we use logical vector like `TRUE` and `FALSE`.

### Exercise 4

Now adds another two argumenst `Tahmid` and `Diego`, and set both of them to `c(TRUE, FALSE)` as well.
```{r all-assignments-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-4-hint-1, eval = FALSE}
expand_grid(Yao = c(TRUE,FALSE),
            Emma = c(TRUE,FALSE),
            Cassidy = c(TRUE,FALSE),
            Tahmid = c(TRUE,FALSE),
            Diego = c(TRUE,FALSE))
```

### 

Now we have an complete 32*5 tibble, which each 32 rwos representing an different possible outcomes. 

### Exercise 5

Use `pivot_longer()` which include two arguments, first set `cols` equal to `everything()`, then set `values_to` equal to `"treatment"`.
```{r all-assignments-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-5-hint-1, eval = FALSE}
...%>%
 pivot_longer(cols = everything(),
             values_to = "treatment")
```

### 

This step allow us to combine the 5 columns in to one, `cols` means combine how many colums, `everything()` means select every columns in the tibble, but if we have 6 columns while only wants to select 5 of them we can use `c(Yao, Emma, Cassidy, Tahmid, Diego)` where we manually select which columns using `c()`.

### Exercise 6

Use `mutate()` creates a new variable `control` which is equal to `! treatment `.
```{r all-assignments-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-6-hint-1, eval = FALSE}
mutate(control = ! treatment) 
```

### 

`!` operator means "not", but since treatment is a logical vector not `TRUE` basically means `FALSE` and vice versa.

### Exercise 7

Use `mutate()` create a new variable `assignment` equal to `rep()` which has two arguments, with first being `1:32` and then set `each` to 5.
```{r all-assignments-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-7-hint-1, eval = FALSE}
mutate(assignment = rep(1:32, each = 5)) 
```

### 

The `rep()` function here is alittle different than the `rep()` we use before where the two arguments is the value and it's repeat times, with `each` we generate each number in the value certain amount of time.


### Exercise 8

Use `relocate()` which has two arguments, the first being `assignment`, then set `.befire` equal to `name`.

```{r all-assignments-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-8-hint-1, eval = FALSE}
relocate(assignment, .before = name)
```

Now you have creates a tibble like this.
```{r}
all_assignments
```

### Exercise 9

Assign everything above in a variable `all_assignments`.
```{r all-assignments-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-9-hint-1, eval = FALSE}
all_assignments <-
  ...
```

### 

### Exercise 10

Start a pipe with `all_assignments`, use `filter()` and filter out `assignment` number `10` and let's see if we can manipulate other assignment just like what we done with the experiment data.

```{r all-assignments-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-10-hint-1, eval = FALSE}
all_assignments %>%
  filter(assignment == 10)
```

### 

We have filter out assignment number 10, where Yao, Cassidy and Tahmid gets treatment, Emma and Diego gets control.

### Exercise 11

Similar to the first section of tutorials let's adds $Y_t$ and $Y_c$ from the preceptor table in our assignment tibble. Use `mutate()` create a new variable `Y_t` and set it equal to `c(13, 14, NA, NA, 3)`.
```{r all-assignments-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-11-hint-1, eval = FALSE}
all_assignments %>%
  filter(assignment == 10) %>%
  mutate(Y_t = c(13, 14, NA, NA, 3))
```

### 

### Exercise 12

Similarly use `mutate()` create a new variable `Y_c` and set it equal to `c(NA, NA, 6, 12, NA)`.
```{r all-assignments-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-12-hint-1, eval = FALSE}
all_assignments %>%
  filter(assignment == 10) %>%
  mutate(Y_t = c(13, 14, NA, NA, 3)) %>%
  mutate(Y_c = c(NA, NA, 6, 12, NA))
```

### 

Now we have the two column which correspond to treatment and control.

### Exercise 13

Use `mutate()` create a variable `c_outcome` and set it equal to `if_else()` which has three arguments in order, `treatment`, then `Y_t` , then `NA_real_`. 
```{r all-assignments-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-13-hint-1, eval = FALSE}
all_assignments %>%
  filter(assignment == 10) %>%
  mutate(Y_t = c(13, 14, NA, NA, 3)) %>%
  mutate(Y_c = c(NA, NA, 6, 12, NA)) %>%
  mutate(t_outcome = if_else(treatment, Y_t, NA_real_))
```

### 

This is an column with 4 NA values, value of 13 for Yao.

### Exercise 14

Similarly, use `mutate()` create a variable `c_outcome` and set it equal to `if_else()` which has three arguments in order, `control`, then `Y_c` , then `NA_real_`. 
```{r all-assignments-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-14-hint-1, eval = FALSE}
all_assignments %>%
  filter(assignment == 10) %>%
  mutate(Y_t = c(13, 14, NA, NA, 3)) %>%
  mutate(Y_c = c(NA, NA, 6, 12, NA)) %>%
  mutate(t_outcome = if_else(treatment, Y_t, NA_real_)) %>%
  mutate(c_outcome = if_else(control, Y_c, NA_real_)) 
```

### 

This is a column with 5 NAs. Now as you may have notice already, the two columns `t_outcome` and `c_outcome` is quite abnormal, when we compared this tibble with the one in the first section below. We can see that in the `Experiment assignment` section we have the `TRUE` in either treatment / control matches with values in corresponding $Y_t$ and $Y_c$, and `FALSSE` match with NA, so when we start combining the two we no longer have the NAs in column `t_outcome` or `c_outcome`. However, this is different for the tibble we just creates, we can see that the `treatment` / `control` columns does not matches with the corresponding `Y_t` and `Y_c` which in the end results in with multiple NAs.

### Exercise 15

Use `summarise()` create an variable `est_effect`, and set it equal to the `mean()` of `t_outcome` minus the `mean()` of `c_outcome`.  Also within both `mean()` set `na.rm` equals `TRUE`.  You should get NaN as your results. 
```{r all-assignments-15, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-assignments-15-hint-1, eval = FALSE}
all_assignments %>%
  filter(assignment == 10) %>%
  mutate(Y_t = c(13, 14, NA, NA, 3)) %>%
  mutate(Y_c = c(NA, NA, 6, 12, NA)) %>%
  mutate(t_outcome = if_else(treatment, Y_t, NA_real_)) %>%
  mutate(c_outcome = if_else(control, Y_c, NA_real_)) %>%
  summarise(est_effect = mean(t_outcome, na.rm = TRUE) - mean(c_outcome, na.rm = TRUE))
```

### 

As expected we cannot compute with NAs or in other word, every operation that includes NA like 2 + NA will results in NA. 

### 

Now, we are stuck. We figure out in section 1 that in order to determine whether our data is sufficient enough to should that the treatment is effective we need to calculate the results of all possible combinations of estimated treatment effect. Yet with incomplete information in the preceptor table, we cannot match the data with the assignment table which has all combinations of treatment control. Does this means that we can't solve this problem ? No, as we have one way to get around with this issue, which is also the core part of *Permutation Test* and that is *Null hypothesis*.


<!-- tibble(assignment number, name, treatment, control) with treatment and control being logical vectors. The tibble has 32 * 5 rows.  -->

## Null hypothesis
### 

*Let's assume that the causal effect for all units is equal to zero. *

```{r echo = FALSE}
# First, we create a tibble with the values we want for the table

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("13", "14", "6", "12", "3"),
       ycontrol = c("13", "14", "6", "12", "3"),
       ydiff = c("0", "0", "0", "0", "0")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
    tab_header(title = "Preceptor Table",
    subtitle = "Data under the assumption that the causal effect is zero for all units") %>% 
    cols_label(subject = md("ID"),
                  ytreat = md("$$Y_t(u)$$"),
                  ycontrol = md("$$Y_c(u)$$"),
                  ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
    cols_move(columns = c(ytreat, ycontrol), after = c(subject)) %>%
    tab_style(cell_borders(sides = "right"),
              location = cells_body(columns = c(subject))) %>%
    tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
              locations = cells_column_labels(columns = c(subject))) %>%
    cols_align(align = "center", columns = everything()) %>%
    cols_align(align = "left", columns = c(subject)) %>%
    tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol)) %>%
    tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff)) %>%
    fmt_markdown(columns = everything())
```


This is our "null hypothesis."

We are assuming that the average treatment effect is 0 and that for example, the value 13 for Yao can be applied to both treatment and control. With this null hypothesis in place we eleminate all the question marks in the preceptor table, and be able to calculate all other 31 possible outcomes of the `assignment` tibble. Essentially, we are proposing an hypothesis, that there is no difference between the outcome with treatment and the outcome with control, we can explore this hypothesis by calculating all possible outcomes of the experiment, and if the average treatment effect of the "real" data appears frequently during all 32 outcomes, this means that our hypothesis is correct which also means that the treatment we give is ineffective.

Let's calculate the estimated treatment effect with Assignment Number 7 (or whatever) if the null hypothesis is correct. 

Need the assignment tibble, from which you are going to take just 5 rows. And you need a vector of 5 numbers which is the outcome. A vector is enough because the null hypothesis assumes that Yao's outcome is the same under treatment and control.

### Exercise 1

```{r null-hypothesis-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-1-hint-1, eval = FALSE}

```

### 

### Exercise 2

```{r null-hypothesis-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-2-hint-1, eval = FALSE}

```

### 

### Exercise 3

```{r null-hypothesis-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-3-hint-1, eval = FALSE}

```

### 

### Exercise 4

```{r null-hypothesis-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-4-hint-1, eval = FALSE}

```

### 

### Exercise 5

```{r null-hypothesis-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-5-hint-1, eval = FALSE}

```

### 

### Exercise 6

```{r null-hypothesis-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-6-hint-1, eval = FALSE}

```

### 

### Exercise 7

```{r null-hypothesis-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-7-hint-1, eval = FALSE}

```

### 

### Exercise 8

```{r null-hypothesis-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-8-hint-1, eval = FALSE}

```

### 

### Exercise 9

```{r null-hypothesis-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-9-hint-1, eval = FALSE}

```

### 

### Exercise 10

```{r null-hypothesis-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r null-hypothesis-10-hint-1, eval = FALSE}

```

### 

## All estimated treatment effects
### 

<!-- Do the same thing as previous section, but for all 32 possible assigments. (Note that two of them will drop out because they are everyone gets treatment or everyone gets control.) Results in 30 numbers. Makes a bar chart of those 30 numbers. -->


```{r}
set.seed(100)
all_assignments %>%
  mutate(Y_t = rep(c(13, 14, NA ,NA ,3), 32)) %>% 
  mutate(Y_c = rep(c(NA, NA, 6, 12, NA), 32)) %>%
  mutate(combine_outcome = coalesce(Y_t,Y_c)) %>%
  mutate(treatment_outcome = if_else(treatment, combine_outcome, NA_real_)) %>%
  mutate(control_outcome =   if_else(control,   combine_outcome, NA_real_)) %>% 
  group_by(assignment) %>%
  summarise(mean_difference = mean(treatment_outcome, na.rm = TRUE) - 
                              mean(control_outcome, na.rm = TRUE)) %>%
  drop_na() %>%
  ggplot(aes(x = mean_difference, fill = mean_difference >= 1)) +
    geom_histogram(aes(y = after_stat(count/sum(count))), 
                   binwidth = 0.15,
                   color = "white")+
    scale_fill_manual(values = c('grey50', 'red')) +
    scale_x_continuous(breaks = seq(-9, 9, 1), labels = -9:9)+
    scale_y_continuous(labels= scales::percent_format(accuracy = 1)) +
  labs(title = "Estimated treatment effect of all assignment",
       subtitle = "Exclude outcomes for 5 treatments and for 5 controls",
       x = "ETE (Estimated Treatment Effect)",
       y = "Occur Frequency",
       fill = "Experiment ETE")
  
```

### Exercise 1

Start a pipe with `all_assignments`, use `mutate()` create a variable `Y_t` which repeat `c(13, 14, NA ,NA ,3)` 32 times
```{r all-estimated-treatm-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-1-hint-1, eval = FALSE}
mutate(Y_t = rep(c(13, 14, NA ,NA ,3), 32)) 
```

### 

### Exercise 2

Similarly, use `mutate()` create a variable `Y_c` which repeat `c(NA, NA, 6, 12, NA)` 32 times
```{r all-estimated-treatm-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-2-hint-1, eval = FALSE}
mutate(Y_c = rep(c(NA, NA, 6, 12, NA), 32))
```

### 

### Exercise 3
Next, use `mutate()` create a new variable `combine_outcome` which is equal to `coalesce()`that takes on two values `Y_t` and `Y_c`.
```{r all-estimated-treatm-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-3-hint-1, eval = FALSE}
mutate(combine_outcome = coalesce(Y_t,Y_c))
```

### 

### Exercise 4

Use `mutate()` create a variable `treatment_outcome` and set it equal to `if_else()` which has three arguments in order, `treatment`, then `combine_outcome` , then `NA_real_`. 
```{r all-estimated-treatm-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-4-hint-1, eval = FALSE}
mutate(treatment_outcome = if_else(treatment, combine_outcome, NA_real_))
```

### 

### Exercise 5
Use `mutate()` create a variable `control_outcome` and set it equal to `if_else()` which has three arguments in order, `control`, then `combine` , then `NA_real_`. 
```{r all-estimated-treatm-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-5-hint-1, eval = FALSE}
mutate(control_outcome =   if_else(control,   combine_outcome, NA_real_))
```

### 

### Exercise 6

Use to `group_by()` to create a group by `assignmen`
```{r all-estimated-treatm-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-6-hint-1, eval = FALSE}
group_by(assignment)
```

### Exercise 7


```{r all-estimated-treatm-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-7-hint, eval = FALSE}

```

###

### Exercise 8


```{r all-estimated-treatm-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-8-hint, eval = FALSE}

```

###

### Exercise 9


```{r all-estimated-treatm-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-9-hint, eval = FALSE}

```

###

### Exercise 10


```{r all-estimated-treatm-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r all-estimated-treatm-10-hint, eval = FALSE}

```

###



## Full example
### 

<!-- Real examples have way more than 5 units. Two things happen. First, there are trillions of possible assignments, so we can't calculate the estimated treatment effect under the null hypothesis for all of them. So, we need to sample. Second, given this wealth of possibility, we purposely chose not to select "weird" assignments. Selected "balanced" treatment assignments, with approximately the same number of treated and control. -->

<!-- Use the whole trains data set. Use att_end as your variable. And then do the whole thing above. In first section, calculate the estimated treatment effect by hand, like: -->

<!-- ```{r} -->
<!-- trains %>% group_by(treatment) %>% summarize(mean(att_end)) -->
<!-- ``` -->

<!-- sample(c(TRUE, FALSE), size = 115, replace = TRUE), probbaly use map functions. -->

```{r}
S_obs <- 
  trains %>% 
  mutate(outcome = att_end - att_start) %>%
  select(treatment, outcome) %>%
  mutate(treatment = case_when(
    treatment == "Treated" ~ TRUE,
    treatment == "Control" ~ FALSE)) %>%
  mutate(control = ! treatment) %>%
  relocate(control, .before = outcome) %>%
  mutate(treatment_outcome = if_else(treatment, outcome, NA_real_)) %>%
  mutate(control_outcome =   if_else(control,   outcome, NA_real_)) %>%
  summarise(mean_difference = mean(treatment_outcome, na.rm = TRUE) - 
                              mean(control_outcome, na.rm = TRUE)) %>%
  pull(mean_difference)
  
  
  
outcome <-
  trains %>%
  mutate(outcome = att_end - att_start) %>%
  pull(outcome)
  

  tibble(ID = 1:5000) %>%
  group_by(ID) %>%
  mutate(treatment = map(ID, ~sample(c(TRUE, FALSE), size = 115, replace = TRUE))) %>%
  mutate(comb_outcome = map(ID, ~c(outcome))) %>%
  select(ID, treatment,comb_outcome) %>%
  unnest(c(ID, treatment,comb_outcome)) %>%
  mutate(control = ! treatment) %>%
  relocate(control, .before = comb_outcome) %>%
  mutate(treatment_outcome = if_else(treatment, comb_outcome, NA_real_)) %>%
  mutate(control_outcome =   if_else(control,   comb_outcome, NA_real_)) %>%
  summarise(mean_difference = mean(treatment_outcome, na.rm = TRUE) - 
                              mean(control_outcome, na.rm = TRUE)) %>%
    ggplot(aes(x = mean_difference, fill = mean_difference >= S_obs)) +
    geom_histogram(aes(y = after_stat(count/sum(count))), 
                   binwidth = 0.05,
                   color = "white") +
    scale_fill_manual(values = c('grey50', 'red')) +
    scale_y_continuous(labels= scales::percent_format(accuracy = 1))+
    labs(title = "Permutation Distribution for trains dataset",
         subtitle = "Experiment oberservation appears at the right tail of distribution",
         x = "ETE (Estimated Treatment Effect)",
         y = "Occur Frequency (percentage)",
         fill = " >= Experiment ETE")
    
  

```


### Exercise 1


```{r full-example-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-1-hint, eval = FALSE}

```

###

### Exercise 2


```{r full-example-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-2-hint, eval = FALSE}

```

###

### Exercise 3


```{r full-example-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-3-hint, eval = FALSE}

```

###

### Exercise 4


```{r full-example-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-4-hint, eval = FALSE}

```

###

### Exercise 5


```{r full-example-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-5-hint, eval = FALSE}

```

###

### Exercise 6


```{r full-example-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-6-hint, eval = FALSE}

```

###

### Exercise 7


```{r full-example-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-7-hint, eval = FALSE}

```

###

### Exercise 8


```{r full-example-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-8-hint, eval = FALSE}

```

###

### Exercise 9


```{r full-example-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-9-hint, eval = FALSE}

```

###

### Exercise 10


```{r full-example-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r full-example-10-hint, eval = FALSE}

```

###



## Summary
### 

```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
